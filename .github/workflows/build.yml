name: Build TensorFlow Java (No AVX, Windows)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-windows-noavx:
    runs-on: windows-latest

    env:
      ACTIONS_STEP_DEBUG: true  # Enable GitHub Actions debug logs

    steps:
      # 1️⃣ Checkout the code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Setup Java 11 for Maven build (fixes --add-exports)
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      # 3️⃣ Install Bazelisk via Chocolatey
      - name: Install Bazelisk
        shell: powershell
        run: |
          choco install bazelisk -y
          bazelisk version

      # 4️⃣ Disable AVX flags in tensorflow.bazelrc
      - name: Disable AVX in Bazel config
        shell: bash
        run: |
          echo "Patching tensorflow.bazelrc to disable AVX..."
          sed -i 's/--copt=\/arch:AVX/--copt=\/arch:SSE2/g' tensorflow.bazelrc || true
          echo "After patching:"
          grep "/arch" tensorflow.bazelrc || true

      # 5️⃣ Build TensorFlow JNI (native library)
      - name: Build TensorFlow JNI (no AVX)
        shell: bash
        run: |
          echo "Building TensorFlow JNI without AVX..."
          bazelisk build --config=opt //tensorflow/java:libtensorflow_jni.dll --copt=-mno-avx --copt=-mno-avx2 --copt=-mno-fma || true

      # 6️⃣ Build TensorFlow Java JARs using Java 11
      - name: Build TensorFlow Java JARs with Debug Logs
        shell: pwsh
        run: |
          echo "Running Maven build with Java 11..."
          java -version
          mvn clean install -pl tensorflow-core/tensorflow-core-api,tensorflow-core/tensorflow-core-native -DskipTests -Pwindows -Pnative-build -X

      # 7️⃣ Upload build artifacts (.jar + .dll)
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tensorflow-java-noavx
          path: |
            tensorflow-core/tensorflow-core-api/target/*.jar
            tensorflow-core/tensorflow-core-native/target/*.jar
            bazel-bin/tensorflow/java/*.dll
