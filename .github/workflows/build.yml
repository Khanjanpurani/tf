name: Build TensorFlow Java (No AVX, Windows)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-windows-noavx:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '8'

      - name: Install Chocolatey and Bazelisk
        shell: powershell
        run: |
          choco install bazelisk -y
          bazelisk version

      - name: Disable AVX in tensorflow.bazelrc
        shell: bash
        run: |
          echo "Patching tensorflow.bazelrc to disable AVX..."
          sed -i 's/--copt=\/arch:AVX/--copt=\/arch:SSE2/g' tensorflow.bazelrc || true
          echo "After patching:"
          grep "/arch" tensorflow.bazelrc || true

      - name: Build TensorFlow JNI (no AVX)
        shell: bash
        run: |
          echo "Building TensorFlow JNI (no AVX)..."
          bazelisk build --config=opt //tensorflow/java:libtensorflow_jni.so --copt=-mno-avx || true

      - name: Build TensorFlow Java JARs
        shell: bash
        run: |
          echo "Running Maven build..."
          mvn clean install -pl tensorflow-core/tensorflow-core-api,tensorflow-core/tensorflow-core-native -DskipTests -Pwindows -Pnative-build

      - name: Upload JAR Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tensorflow-java-noavx-jars
          path: |
            tensorflow-core/tensorflow-core-api/target/*.jar
            tensorflow-core/tensorflow-core-native/target/*.jar
