name: Build TensorFlow Java (No AVX, Windows)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-windows-noavx:
    runs-on: windows-latest
    env:
      ACTIONS_STEP_DEBUG: true  # Debug logs

    steps:
      # 1️⃣ Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Setup Java 11
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      # 3️⃣ Install Bazelisk
      - name: Install Bazelisk
        shell: powershell
        run: |
          choco install bazelisk -y
          bazelisk version

      # 4️⃣ Set MSVC toolchain paths
      - name: Configure MSVC toolchain for Bazel
        shell: pwsh
        run: |
          # Visual Studio 2019 BuildTools path
          $vc_path = "C:\Program Files (x86)\Microsoft Visual Studio\2019\BuildTools\VC"
          $sdk_path = "C:\Program Files (x86)\Windows Kits\10"
          if (-Not (Test-Path $vc_path)) { throw "VC path not found: $vc_path" }
          if (-Not (Test-Path $sdk_path)) { throw "WinSDK path not found: $sdk_path" }

          # Set Bazel env vars
          $env:BAZEL_VC=$vc_path
          $env:BAZEL_WINSDK=$sdk_path
          echo "BAZEL_VC = $env:BAZEL_VC"
          echo "BAZEL_WINSDK = $env:BAZEL_WINSDK"

      # 5️⃣ Disable AVX in tensorflow.bazelrc
      - name: Disable AVX
        shell: bash
        run: |
          sed -i 's/--copt=\/arch:AVX/--copt=\/arch:SSE2/g' tensorflow.bazelrc || true

      # 6️⃣ Build JNI DLL
      - name: Build JNI DLL
        shell: bash
        run: |
          bazelisk build --config=opt //tensorflow/java:libtensorflow_jni.dll --copt=-mno-avx --copt=-mno-avx2 --copt=-mno-fma

      # 7️⃣ Build Java JARs
      - name: Build TensorFlow Java JARs
        shell: pwsh
        run: |
          java -version
          mvn clean install -pl tensorflow-core/tensorflow-core-api,tensorflow-core/tensorflow-core-native -DskipTests -Pwindows -Pnative-build -X

      # 8️⃣ Upload artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tensorflow-java-noavx
          path: |
            tensorflow-core/tensorflow-core-api/target/*.jar
            tensorflow-core/tensorflow-core-native/target/*.jar
            bazel-bin/tensorflow/java/*.dll
